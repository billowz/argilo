# encrypt: https://ci.appveyor.com/tools/encrypt
# validate: https://ci.appveyor.com/tools/validate-yaml

version: "{build}"
image: Visual Studio 2015

cache:
  - '%APPDATA%\npm-cache'
  - node_modules -> package.json
  - package-lock.json -> package.json

environment:
  CI_NAME: 'appveyor'
  NODEJS_VERSION: '10'
  NPM_TOKEN:
    secure: zTogpCh9AtlTR+osabCb9UMXMtIT8qTE0Rvay78bTORSysIVo5Ev+y6oOsHdDSO9
  GH_TOKEN:
    secure: wMVG1uvMB8qswngCrsL0eg6E/7HEaCjbAmXFM26V+sVO1OnP1/mgMu6kGX2uCWm0
  COVERALLS_REPO_TOKEN:
    secure: h7+00+xENrj5Y75g+WWNZ/aECu3wFLlGWY8MuNMXZ5iFzC3Mqk/Rb0J0BldYq8Yb

init:
  - echo "the build worker image is %APPVEYOR_BUILD_WORKER_IMAGE%"
  - git config --global core.autocrlf input

install:
  - ps: |
      Install-Product node $env:NODEJS_VERSION

      echo "the node version is $(node --version)"
      echo "the npm version is $(npm --version)"

      $branch    = $(node -p "require('./package.json').branch")
      $last_tag  = $(git tag -l --merged origin/$branch --sort=-taggerdate)
      $last_tag  = $(if ($last_tag) {$last_tag[0]} else {$(node -p "require('./package.json').version")})
      $test_type = $(if ($env:APPVEYOR_REPO_BRANCH -eq $branch) {"test"} else {"dev-test"})
      $title     = "$test_type $(if ($env:APPVEYOR_REPO_TAG_NAME) {"for $branch@$last_tag"} else {"on $branch@$last_tag""})"
      echo $title
      Update-AppveyorBuild -Version "$title ($env:APPVEYOR_BUILD_NUMBER)"

  - npm install -g coveralls
  - npm install

build_script:
  - npm run package

test_script:
  - npm run unit:node
  - npm run unit:browser -- --browsers IE8,IE9,Chrome --single-run
  - npm run unit:browser -- --browsers IE6,IE7 --single-run --no-iframe

after_test:
  - cat coverage/*/lcov.info | coveralls

deploy_script:
  - npx semantic-release -d -p @semantic-release/commit-analyzer
  - echo "======================================"
  - ps: |
      npx semantic-release
      $next_tag=$(git tag -l --merged master --sort=-taggerdate)
      if ( $next_tag -and $next_tag[0] -ne $last_tag )
      {
        Update-AppveyorBuild -Version "release`:` $last_tag -> $next_tag[0]"
      }
